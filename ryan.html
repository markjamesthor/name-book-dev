<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¼ì´ì–¸ë¶ - ë§ì¶¤í˜• ë™í™”ì±… ìƒì„±ê¸°</title>
    <!-- HEIC ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --dark: #2C3E50;
            --light: #F7F9FC;
            --success: #27AE60;
            --warning: #F39C12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 16px;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
        }

        /* ì…ë ¥ íŒ¨ë„ */
        .input-panel {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section h3 {
            font-size: 1.1rem;
            color: var(--dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* ì…ë ¥ í•„ë“œ */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 6px;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E8E8E8;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--secondary);
        }

        /* ë¬¼ê±´ ì…ë ¥ ì¹´ë“œ */
        .object-card {
            background: #F8F9FA;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .object-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .object-card .card-header span {
            font-weight: 600;
            color: var(--primary);
        }

        .object-card .object-name {
            margin-bottom: 12px;
        }

        /* ì‚¬ì§„ ì—…ë¡œë“œ */
        .photo-upload {
            border: 2px dashed #DDD;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .photo-upload:hover {
            border-color: var(--secondary);
            background: rgba(78, 205, 196, 0.05);
        }

        .photo-upload.dragover {
            border-color: var(--primary);
            background: rgba(255, 107, 107, 0.1);
            transform: scale(1.02);
        }

        .photo-upload.has-image {
            padding: 0;
            border-style: solid;
        }

        .photo-upload img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }

        .photo-upload .upload-text {
            color: #999;
            font-size: 0.9rem;
        }

        .photo-upload input[type="file"] {
            display: none;
        }

        /* ê°€ì¡± êµ¬ì„±ì› */
        .family-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .family-member {
            background: #F8F9FA;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .family-member:hover {
            background: #F0F0F0;
        }

        .family-member.selected {
            border-color: var(--secondary);
            background: rgba(78, 205, 196, 0.1);
        }

        .family-member .emoji {
            font-size: 2rem;
            margin-bottom: 4px;
        }

        .family-member .relation {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .family-member .photo-slot {
            margin-top: 8px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #DDD;
            margin: 8px auto 0;
            overflow: hidden;
        }

        .family-member .photo-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ë²„íŠ¼ */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #E55A5A;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        /* í”„ë¦¬ë·° íŒ¨ë„ */
        .preview-panel {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .preview-header h2 {
            font-size: 1.3rem;
        }

        .page-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .page-nav button {
            width: 36px;
            height: 36px;
            border: none;
            background: #F0F0F0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .page-nav button:hover {
            background: #E0E0E0;
        }

        .page-nav span {
            font-size: 0.9rem;
            color: #666;
            min-width: 80px;
            text-align: center;
        }

        /* ì±… í”„ë¦¬ë·° */
        .book-preview {
            background: #F8F9FA;
            border-radius: 12px;
            padding: 20px;
            max-height: 450px;
        }

        .spread {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: 350px;
            max-height: 350px;
        }

        .page {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            max-height: 350px;
        }

        .page.left {
            border-right: 1px solid #EEE;
        }

        .page-number {
            position: absolute;
            bottom: 10px;
            font-size: 0.8rem;
            color: #999;
        }

        .page-content {
            text-align: center;
            width: 100%;
        }

        .page-content .character-img {
            width: 120px;
            height: 120px;
            background: #F0F0F0;
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .page-content .dialogue {
            font-size: 1.2rem;
            line-height: 1.8;
            color: var(--dark);
        }

        .page-content .child-name {
            color: var(--primary);
            font-weight: 700;
        }

        /* í˜ì´ì§€ ì¸ë„¤ì¼ */
        .thumbnails {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .thumbnail {
            flex-shrink: 0;
            width: 60px;
            height: 84px;
            background: white;
            border: 2px solid #EEE;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #999;
        }

        .thumbnail:hover {
            border-color: var(--secondary);
        }

        .thumbnail.active {
            border-color: var(--primary);
            background: rgba(255, 107, 107, 0.1);
        }

        /* ìŠ¤í‚¤ë§ˆ ì •ë³´ */
        .schema-info {
            margin-top: 20px;
            padding: 16px;
            background: #F8F9FA;
            border-radius: 10px;
            font-family: 'Monaco', monospace;
            font-size: 0.75rem;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
        }

        /* ì‚¬ë¬¼ í˜¸ì¹­ ì˜µì…˜ */
        .josa-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .josa-option {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #F8F9FA;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .josa-option:hover {
            background: #F0F0F0;
        }

        .josa-option.selected {
            border-color: var(--secondary);
            background: rgba(78, 205, 196, 0.1);
        }

        .josa-option input[type="radio"] {
            display: none;
        }

        .josa-option .option-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .josa-option .option-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .josa-option .option-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--dark);
        }

        .josa-option .option-example {
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
        }

        /* ë¬¼ê±´ë³„ í˜¸ì¹­ í† ê¸€ */
        .josa-toggle {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .josa-btn {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #DDD;
            background: #F8F9FA;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .josa-btn:hover {
            background: #F0F0F0;
        }

        .josa-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .josa-preview {
            margin-top: 8px;
            padding: 8px 12px;
            background: #FFF9E6;
            border-left: 3px solid var(--accent);
            border-radius: 4px;
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
        }

        /* Ryan ìŠ¤íƒ€ì¼ í¼ ë ˆì´ì•„ì›ƒ */
        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-group.half {
            flex: 1;
        }

        .gender-toggle {
            display: flex;
            gap: 8px;
        }

        .gender-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #E8E8E8;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gender-btn:hover {
            border-color: var(--secondary);
        }

        .gender-btn.active {
            border-color: var(--primary);
            background: rgba(255, 107, 107, 0.1);
        }

        /* ì¡°ì‚¬ ë°ëª¨ íŒ¨ë„ */
        .josa-demo-section {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF5F5 100%);
            border-radius: 12px;
            padding: 16px !important;
        }

        .josa-demo {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .josa-demo-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .josa-demo-item .label {
            min-width: 80px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.75rem;
        }

        .josa-demo-item .example {
            color: #666;
            flex: 1;
        }

        .josa-demo-item .example .highlight {
            color: var(--primary);
            font-weight: 600;
        }

        .josa-demo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #DDD;
        }

        .josa-demo-header .name-display {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .josa-demo-header .batchim-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .josa-demo-header .batchim-badge.has {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .josa-demo-header .batchim-badge.no {
            background: #FFF3E0;
            color: #E65100;
        }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: var(--dark);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ë¼ì´ì–¸ë¶ í”„ë¡œí† íƒ€ì…</h1>
            <p>Chain Reaction ë™í™”ì±… ìë™ ìƒì„± ì‹œìŠ¤í…œ v0.1</p>
        </header>

        <div class="main-layout">
            <!-- ì…ë ¥ íŒ¨ë„ -->
            <div class="input-panel">
                <!-- ê¸°ë³¸ ì •ë³´ (Ryan Style) -->
                <div class="section">
                    <h3>ê¸°ë³¸ ì •ë³´</h3>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>ì„±</label>
                            <input type="text" id="childLastName" placeholder="ì˜ˆ: ê¹€" value="ê¹€">
                        </div>
                        <div class="form-group half">
                            <label>ì´ë¦„</label>
                            <input type="text" id="childFirstName" placeholder="ì˜ˆ: ë„í˜„" value="ë„í˜„" oninput="updateChildName()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>ì„±ë³„</label>
                            <div class="gender-toggle">
                                <button class="gender-btn active" data-gender="boy" onclick="setGender('boy')">ğŸ‘¦ ë‚¨ì•„</button>
                                <button class="gender-btn" data-gender="girl" onclick="setGender('girl')">ğŸ‘§ ì—¬ì•„</button>
                            </div>
                        </div>
                        <div class="form-group half">
                            <label>ìƒì¼</label>
                            <input type="date" id="childBirthday" value="2020-01-01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì•„ì´ ì‚¬ì§„</label>
                        <div class="photo-upload has-image" id="childPhotoUpload" onclick="document.getElementById('childPhoto').click()">
                            <input type="file" id="childPhoto" accept="image/*">
                            <img src="ryan_test_images/0_ë„í˜„.JPG" alt="ì•„ì´ ì‚¬ì§„">
                        </div>
                    </div>
                </div>

                <!-- ì¡°ì‚¬ ë¯¸ë¦¬ë³´ê¸° ë°ëª¨ -->
                <div class="section josa-demo-section">
                    <h3>ğŸ“ ì¡°ì‚¬ ë¯¸ë¦¬ë³´ê¸°</h3>
                    <div class="josa-demo" id="josaDemoPanel">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>

                <!-- ì¢‹ì•„í•˜ëŠ” ë¬¼ê±´ë“¤ -->
                <div class="section">
                    <h3>ì¢‹ì•„í•˜ëŠ” ê²ƒë“¤ (Favorites)</h3>
                    <p style="font-size: 0.85rem; color: #888; margin-bottom: 12px;">ì•„ì´ê°€ ì¢‹ì•„í•˜ëŠ” ì‚¬ë¬¼/ì¹œêµ¬ ì´ë¦„ (ìµœëŒ€ 4ê°œ)</p>
                    <div id="objectsContainer">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>

                <!-- ê°€ì¡± êµ¬ì„±ì› -->
                <div class="section">
                    <h3>ê°€ì¡± êµ¬ì„±ì›</h3>
                    <p style="font-size: 0.85rem; color: #888; margin-bottom: 12px;">ë“±ì¥í•  ê°€ì¡±ì„ ì„ íƒí•˜ê³  í˜¸ì¹­ì„ ì…ë ¥í•˜ì„¸ìš”</p>
                    <div class="family-grid" id="familyGrid">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>

                <!-- ìƒì„± ë²„íŠ¼ -->
                <button class="btn btn-primary" onclick="generateBook()">
                    ë™í™”ì±… ìƒì„±í•˜ê¸°
                </button>
            </div>

            <!-- í”„ë¦¬ë·° íŒ¨ë„ -->
            <div class="preview-panel">
                <div class="preview-header">
                    <h2>ì±… ë¯¸ë¦¬ë³´ê¸°</h2>
                    <div class="page-nav">
                        <button onclick="prevSpread()">&#8249;</button>
                        <span id="pageIndicator">1-2 / 24</span>
                        <button onclick="nextSpread()">&#8250;</button>
                    </div>
                </div>

                <div class="book-preview">
                    <div class="spread" id="bookSpread">
                        <div class="page left" id="leftPage">
                            <div class="page-content">
                                <p style="color: #999;">ì™¼ìª½ í˜ì´ì§€</p>
                            </div>
                            <span class="page-number">1</span>
                        </div>
                        <div class="page right" id="rightPage">
                            <div class="page-content">
                                <p style="color: #999;">ì˜¤ë¥¸ìª½ í˜ì´ì§€</p>
                            </div>
                            <span class="page-number">2</span>
                        </div>
                    </div>
                </div>

                <!-- í˜ì´ì§€ ì¸ë„¤ì¼ -->
                <div class="thumbnails" id="thumbnails">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>

                <!-- ìŠ¤í‚¤ë§ˆ ì •ë³´ -->
                <div class="schema-info" id="schemaInfo">
                    // Master Schemaê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // Master Schema - í…Œë§ˆ ì„¤ì •
        // ============================================
        const THEME_CONFIG = {
            themeId: "ryan_default",
            themeName: "ë‚˜ë‹ˆë…¸ë‡¨ í† ë¼",

            // Chain Characters - ì—°ì‡„ë°˜ì‘ ìºë¦­í„°ë“¤
            chainCharacters: [
                { id: "char1", name: "ë‚˜ë‹ˆë…¸ë‡¨ í† ë¼", emoji: "ğŸ°", defaultImg: null },
                { id: "char2", name: "íƒ€ìš”", emoji: "ğŸšŒ", defaultImg: null },
                { id: "char3", name: "íˆ¬ë‹™", emoji: "ğŸ¥•", defaultImg: null },
                { id: "char4", name: "í˜ì†Œ", emoji: "ğŸ§", defaultImg: null }
            ],

            // í…ìŠ¤íŠ¸ í…œí”Œë¦¿
            texts: {
                title: "ë‚˜ëŠ” {objectName}ë¥¼ ì¢‹ì•„í•´",
                question: "{actorName},\në„ˆëŠ” ë­˜ ì¢‹ì•„í•´?",
                answer: "ë‚˜ëŠ” {targetName}ë¥¼ ì¢‹ì•„í•´.",
                climax: "ê·¸ëŸ¼ {targetName}ëŠ”\në­˜ ì œì¼ ì¢‹ì•„í•˜ëƒë©´...",
                childReveal: "ë°”ë¡œ {childName}!",
                familyLove: "ìš°ë¦¬ë„ {childName} ì¢‹ì•„í•´!",
                childLoveBack: "ë‚˜ë„ {relations} ì¢‹ì•„í•´!",
                secret: "ë¹„ë°€ì¸ë°...\n{childName}ê°€ ì œì¼ ì¢‹ì•„í•˜ëŠ” ê±´\në°”ë¡œ ë„ˆì•¼!"
            },

            // í˜ì´ì§€ êµ¬ì¡° ì •ì˜ (24í˜ì´ì§€)
            pageStructure: [
                { page: 1, type: "title", template: "title" },
                { page: 2, type: "intro", template: "child_intro" },
                { page: 3, type: "chain_question", chainIndex: 0 },
                { page: 4, type: "chain_answer", chainIndex: 0 },
                { page: 5, type: "chain_question", chainIndex: 1 },
                { page: 6, type: "chain_answer", chainIndex: 1 },
                { page: 7, type: "chain_question", chainIndex: 2 },
                { page: 8, type: "chain_answer", chainIndex: 2 },
                { page: 9, type: "chain_question", chainIndex: 3 },
                { page: 10, type: "chain_answer", chainIndex: 3 },
                { page: 11, type: "climax_question" },
                { page: 12, type: "climax_heart" },
                { page: 13, type: "child_reveal" },
                { page: 14, type: "all_together" },
                { page: 15, type: "family_intro" },
                { page: 16, type: "family_grid" },
                { page: 17, type: "family_grid_2" },
                { page: 18, type: "child_loves_family" },
                { page: 19, type: "child_loves_family_2" },
                { page: 20, type: "who_best" },
                { page: 21, type: "secret" },
                { page: 22, type: "character_intro" },
                { page: 23, type: "character_intro_2" },
                { page: 24, type: "credits" }
            ]
        };

        // ============================================
        // í•œê¸€ ì¡°ì‚¬ ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹° (Ryan Book Style)
        // ============================================

        // ë°›ì¹¨(ì¢…ì„±) í™•ì¸
        function hasJongseong(char) {
            const code = char.charCodeAt(0);
            if (code < 0xAC00 || code > 0xD7A3) return false;
            return (code - 0xAC00) % 28 !== 0;
        }

        // ë§ˆì§€ë§‰ ê¸€ì ê°€ì ¸ì˜¤ê¸°
        function getLastChar(str) {
            if (!str || str.length === 0) return '';
            return str.charAt(str.length - 1);
        }

        // ë°›ì¹¨ ì—¬ë¶€ í™•ì¸ (ë‹¨ì–´ ì „ì²´)
        function hasBatchim(word) {
            return hasJongseong(getLastChar(word));
        }

        // ============================================
        // Ryan Book ì •êµí•œ ì¡°ì‚¬ ì²˜ë¦¬ ì‹œìŠ¤í…œ
        // ============================================
        // 9ê°€ì§€ ì¡°ì‚¬ ìŒì„ ì§€ì›í•˜ëŠ” ì™„ì „í•œ ì¡°ì‚¬ ì²˜ë¦¬
        const JOSA_PAIRS = {
            // ì£¼ê²© (ì´/ê°€)
            'subjective': { withBatchim: 'ì´', withoutBatchim: 'ê°€' },
            'i_ga': { withBatchim: 'ì´', withoutBatchim: 'ê°€' },

            // ëª©ì ê²© (ì„/ë¥¼)
            'objective': { withBatchim: 'ì„', withoutBatchim: 'ë¥¼' },
            'eul_reul': { withBatchim: 'ì„', withoutBatchim: 'ë¥¼' },

            // ì£¼ê²© ê°•ì¡° (ì´ëŠ”/ëŠ”) - "ê³°ì´ëŠ” ì‚¬ê³¼ëŠ”"
            'topic': { withBatchim: 'ì´ëŠ”', withoutBatchim: 'ëŠ”' },
            'i_neun': { withBatchim: 'ì´ëŠ”', withoutBatchim: 'ëŠ”' },

            // ëª©ì ê²© ê°•ì¡° (ì´ë¥¼/ë¥¼) - â˜… Ryanì±… í•µì‹¬: "ê³°ì´ë¥¼ ì¢‹ì•„í•´"
            'objective_emphasis': { withBatchim: 'ì´ë¥¼', withoutBatchim: 'ë¥¼' },
            'i_reul': { withBatchim: 'ì´ë¥¼', withoutBatchim: 'ë¥¼' },

            // ì†Œìœ ê²© (ì´ì˜/ì˜)
            'possessive': { withBatchim: 'ì´ì˜', withoutBatchim: 'ì˜' },
            'i_eui': { withBatchim: 'ì´ì˜', withoutBatchim: 'ì˜' },

            // í˜¸ì¹­ (ì•„/ì•¼)
            'vocative': { withBatchim: 'ì•„', withoutBatchim: 'ì•¼' },
            'a_ya': { withBatchim: 'ì•„', withoutBatchim: 'ì•¼' },

            // ì„œìˆ ê²© ì¡´ëŒ“ë§ (ì´ì—ìš”/ì˜ˆìš”)
            'copula_polite': { withBatchim: 'ì´ì—ìš”', withoutBatchim: 'ì˜ˆìš”' },
            'ieyo_yeyo': { withBatchim: 'ì´ì—ìš”', withoutBatchim: 'ì˜ˆìš”' },

            // ì„œìˆ ê²© ë°˜ë§ (ì´ì•¼/ì•¼)
            'copula_casual': { withBatchim: 'ì´ì•¼', withoutBatchim: 'ì•¼' },
            'iya_ya': { withBatchim: 'ì´ì•¼', withoutBatchim: 'ì•¼' },

            // ê³µë™ê²© (ì´ë„¤/ë„¤) - "ê³°ì´ë„¤ ì§‘"
            'collective': { withBatchim: 'ì´ë„¤', withoutBatchim: 'ë„¤' },
            'i_ne': { withBatchim: 'ì´ë„¤', withoutBatchim: 'ë„¤' },

            // ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€
            'ì„ë¥¼': { withBatchim: 'ì„', withoutBatchim: 'ë¥¼' },
            'ë¥¼': { withBatchim: 'ì„', withoutBatchim: 'ë¥¼' },
            'ì´ê°€': { withBatchim: 'ì´', withoutBatchim: 'ê°€' },
            'ê°€': { withBatchim: 'ì´', withoutBatchim: 'ê°€' },
            'ì€ëŠ”': { withBatchim: 'ì€', withoutBatchim: 'ëŠ”' },
            'ëŠ”': { withBatchim: 'ì€', withoutBatchim: 'ëŠ”' },
            'ê³¼ì™€': { withBatchim: 'ê³¼', withoutBatchim: 'ì™€' },
            'ì™€': { withBatchim: 'ê³¼', withoutBatchim: 'ì™€' },
            'ì•„ì•¼': { withBatchim: 'ì•„', withoutBatchim: 'ì•¼' },
            'ì•¼': { withBatchim: 'ì•„', withoutBatchim: 'ì•¼' },
            'ì´': { withBatchim: 'ì´', withoutBatchim: '' }
        };

        // ì¡°ì‚¬ ê°€ì ¸ì˜¤ê¸°
        function getJosa(word, type) {
            const pair = JOSA_PAIRS[type];
            if (!pair) return '';
            return hasBatchim(word) ? pair.withBatchim : pair.withoutBatchim;
        }

        // ê¸°ì¡´ josa í•¨ìˆ˜ (í˜¸í™˜ì„± ìœ ì§€)
        function josa(word, type) {
            return getJosa(word, type);
        }

        // ë‹¨ì–´ + ì¡°ì‚¬ ê²°í•©
        function withJosa(word, type) {
            return word + getJosa(word, type);
        }

        // ============================================
        // Ryan Book ì¡°ì‚¬ ë°ëª¨ ìƒì„±ê¸°
        // ============================================
        function generateJosaDemo(name) {
            return {
                name: name,
                hasBatchim: hasBatchim(name),
                examples: {
                    subjective: `${name}${getJosa(name, 'subjective')} ì¢‹ì•„!`,           // ì´/ê°€
                    objective: `${name}${getJosa(name, 'objective')} ì¢‹ì•„í•´`,            // ì„/ë¥¼
                    topic: `${name}${getJosa(name, 'topic')} ë­˜ ì¢‹ì•„í•´?`,                // ì´ëŠ”/ëŠ”
                    objective_emphasis: `${name}${getJosa(name, 'objective_emphasis')} ì¢‹ì•„í•´`, // ì´ë¥¼/ë¥¼ â˜…
                    possessive: `${name}${getJosa(name, 'possessive')} ì‚¬ì§„`,            // ì´ì˜/ì˜
                    vocative: `${name}${getJosa(name, 'vocative')}, ì•ˆë…•!`,              // ì•„/ì•¼
                    copula_polite: `ì´ê±´ ${name}${getJosa(name, 'copula_polite')}`,      // ì´ì—ìš”/ì˜ˆìš”
                    copula_casual: `ì´ê±´ ${name}${getJosa(name, 'copula_casual')}`,      // ì´ì•¼/ì•¼
                    collective: `${name}${getJosa(name, 'collective')} ì§‘`               // ì´ë„¤/ë„¤
                }
            };
        }

        // ============================================
        // ì‚¬ë¬¼ í˜¸ì¹­ ì²˜ë¦¬ (ì˜ì¸í™” ì˜µì…˜)
        // ============================================

        // ì‚¬ë¬¼ ì´ë¦„ì„ ì˜ì¸í™” í˜•íƒœë¡œ ë³€í™˜ (ë°›ì¹¨ ìˆìœ¼ë©´ -ì´ ì¶”ê°€)
        // ì˜ˆ: ë¡œë´‡ -> ë¡œë´‡ì´, ê³° -> ê³°ì´, í† ë¼ -> í† ë¼ (ë°›ì¹¨ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ)
        function personifyObject(name) {
            const lastChar = getLastChar(name);
            if (hasJongseong(lastChar)) {
                return name + 'ì´';
            }
            return name;
        }

        // ì‚¬ë¬¼ì— ì¡°ì‚¬ ë¶™ì´ê¸° (ì˜µì…˜ì— ë”°ë¼ ì˜ì¸í™” ì²˜ë¦¬)
        // mode: 'friend' (ì˜ì¸í™”) ë˜ëŠ” 'object' (ì‚¬ë¬¼)
        function objectWithJosa(name, type, mode = 'friend') {
            if (mode === 'friend') {
                // ì˜ì¸í™” ëª¨ë“œ: ë°›ì¹¨ ìˆëŠ” ì´ë¦„ì€ -ì´ë¥¼ ë¶™ì—¬ì„œ ì²˜ë¦¬
                const personified = personifyObject(name);
                return personified + josa(personified, type);
            } else {
                // ì‚¬ë¬¼ ëª¨ë“œ: ê·¸ëŒ€ë¡œ ì¡°ì‚¬ ë¶™ì´ê¸°
                return name + josa(name, type);
            }
        }

        // ì‚¬ë¬¼ í˜¸ì¹­ (ë¶€ë¥´ëŠ” ë§) - ì˜ì¸í™”ë©´ ì•„/ì•¼, ì‚¬ë¬¼ì´ë©´ ìƒëµ
        // ì˜ˆ: friend ëª¨ë“œ -> "ë¡œë´‡ì•„," / "í† ë¼ì•¼,"
        // ì˜ˆ: object ëª¨ë“œ -> "ë¡œë´‡," / "í† ë¼,"
        function objectVocative(name, mode = 'friend') {
            if (mode === 'friend') {
                // ì˜ì¸í™”: ë°›ì¹¨ ìˆìœ¼ë©´ "ë¡œë´‡ì•„", ì—†ìœ¼ë©´ "í† ë¼ì•¼"
                const personified = personifyObject(name);
                return personified + josa(personified, 'ì•¼');
            } else {
                // ì‚¬ë¬¼: ê·¸ëƒ¥ ì´ë¦„ë§Œ
                return name;
            }
        }

        // ============================================
        // ì„œë²„ ì„¤ì •
        // ============================================
        const SERVER_CONFIG = {
            MAIN_URL: 'http://localhost:5001',      // ë°°ê²½ ì œê±° ì„œë²„ (ë¡œì»¬)
            BACKUP_URL: 'http://172.30.1.51:5000',  // ë°±ì—… ì„œë²„ (Windows/RTX)
            TIMEOUT: 30000
        };

        // ============================================
        // í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ ê²½ë¡œ
        // ============================================
        const TEST_IMAGES_PATH = 'ryan_test_images/';
        const TEST_DATA = {
            childName: "ë„í˜„",
            childPhoto: TEST_IMAGES_PATH + '0_ë„í˜„.JPG',
            objects: [
                { name: "í† ë¼", photo: TEST_IMAGES_PATH + '1_í† ë¼.jpeg', emoji: "ğŸ°", josaMode: "friend" },
                { name: "í† ë§ˆí† ", photo: TEST_IMAGES_PATH + '2_í† ë§ˆí† .jpeg', emoji: "ğŸ…", josaMode: "object" },
                { name: "ì‚¬ê³¼ê°€ ì¿µ", photo: TEST_IMAGES_PATH + '3_ì‚¬ê³¼ê°€ ì¿µ.jpeg', emoji: "ğŸ", josaMode: "object" },
                { name: "ì—„ë§ˆ ì•„ì´í°", photo: TEST_IMAGES_PATH + '4_ì—„ë§ˆ ì•„ì´í°.jpeg', emoji: "ğŸ“±", josaMode: "object" }
            ]
        };

        // ============================================
        // ìƒíƒœ ê´€ë¦¬
        // ============================================
        const state = {
            // ê¸°ë³¸ ì •ë³´
            childLastName: "ê¹€",
            childFirstName: "ë„í˜„",
            childName: "ë„í˜„",  // ì±…ì— ì‚¬ìš©ë˜ëŠ” ì´ë¦„ (ì´ë¦„ë§Œ)
            childFullName: "ê¹€ë„í˜„",  // ì „ì²´ ì´ë¦„
            gender: "boy",
            birthday: "2020-01-01",
            childPhoto: TEST_DATA.childPhoto,
            // ì¢‹ì•„í•˜ëŠ” ê²ƒë“¤
            objects: TEST_DATA.objects.map(obj => ({ ...obj, josaMode: obj.josaMode || 'friend' })),
            // ê°€ì¡±
            familyMembers: [],
            // ì±… ìƒíƒœ
            currentSpread: 0,
            generatedBook: null
        };

        // ê°€ì¡± êµ¬ì„±ì› ì˜µì…˜
        const FAMILY_OPTIONS = [
            { id: "dad", relation: "ì•„ë¹ ", emoji: "ğŸ‘¨" },
            { id: "mom", relation: "ì—„ë§ˆ", emoji: "ğŸ‘©" },
            { id: "grandpa", relation: "í• ì•„ë²„ì§€", emoji: "ğŸ‘´" },
            { id: "grandma", relation: "í• ë¨¸ë‹ˆ", emoji: "ğŸ‘µ" },
            { id: "uncle", relation: "ì‚¼ì´Œ", emoji: "ğŸ‘¨â€ğŸ¦±" },
            { id: "aunt", relation: "ì´ëª¨", emoji: "ğŸ‘©â€ğŸ¦±" },
            { id: "brother", relation: "í˜•/ì˜¤ë¹ ", emoji: "ğŸ‘¦" },
            { id: "sister", relation: "ì–¸ë‹ˆ/ëˆ„ë‚˜", emoji: "ğŸ‘§" }
        ];

        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        function init() {
            renderObjectInputs();
            renderFamilyGrid();
            renderThumbnails();
            renderJosaDemo();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ - ì´ë¦„ ì…ë ¥
            document.getElementById('childFirstName').addEventListener('input', (e) => {
                updateChildName();
            });

            document.getElementById('childLastName').addEventListener('input', (e) => {
                updateChildName();
            });

            document.getElementById('childPhoto').addEventListener('change', (e) => {
                handlePhotoUpload(e, 'child');
            });

            // ì•„ì´ ì‚¬ì§„ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            setupDropZone(document.getElementById('childPhotoUpload'), 'child');
        }

        // ============================================
        // ì´ë¦„ ì—…ë°ì´íŠ¸ ë° ì¡°ì‚¬ ë°ëª¨
        // ============================================
        function updateChildName() {
            const firstName = document.getElementById('childFirstName').value || '';
            const lastName = document.getElementById('childLastName').value || '';
            state.childFirstName = firstName;
            state.childLastName = lastName;
            state.childName = firstName;  // ì±…ì—ëŠ” ì´ë¦„ë§Œ ì‚¬ìš©
            state.childFullName = lastName + firstName;
            renderJosaDemo();
        }

        function setGender(gender) {
            state.gender = gender;
            document.querySelectorAll('.gender-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.gender === gender);
            });
        }

        // ì¡°ì‚¬ ë°ëª¨ ë Œë”ë§
        function renderJosaDemo() {
            const panel = document.getElementById('josaDemoPanel');
            const name = state.childName || 'ì´ë¦„';
            const demo = generateJosaDemo(name);

            const josaPairs = [
                { key: 'subjective', label: 'ì£¼ê²© (ì´/ê°€)', desc: '~ì´/ê°€ ì¢‹ì•„!' },
                { key: 'objective', label: 'ëª©ì ê²© (ì„/ë¥¼)', desc: '~ì„/ë¥¼ ì¢‹ì•„í•´' },
                { key: 'topic', label: 'ì£¼ì œ (ì´ëŠ”/ëŠ”)', desc: '~ì´ëŠ”/ëŠ” ë­˜ ì¢‹ì•„í•´?' },
                { key: 'objective_emphasis', label: 'â˜… ê°•ì¡° (ì´ë¥¼/ë¥¼)', desc: '~ì´ë¥¼/ë¥¼ ì¢‹ì•„í•´' },
                { key: 'vocative', label: 'í˜¸ì¹­ (ì•„/ì•¼)', desc: '~ì•„/ì•¼, ì•ˆë…•!' },
                { key: 'copula_polite', label: 'ì„œìˆ  (ì´ì—ìš”/ì˜ˆìš”)', desc: 'ì´ê±´ ~ì´ì—ìš”/ì˜ˆìš”' },
                { key: 'copula_casual', label: 'ë°˜ë§ (ì´ì•¼/ì•¼)', desc: 'ì´ê±´ ~ì´ì•¼/ì•¼' },
                { key: 'collective', label: 'ê³µë™ (ì´ë„¤/ë„¤)', desc: '~ì´ë„¤/ë„¤ ì§‘' }
            ];

            panel.innerHTML = `
                <div class="josa-demo-header">
                    <span class="name-display">${name}</span>
                    <span class="batchim-badge ${demo.hasBatchim ? 'has' : 'no'}">
                        ${demo.hasBatchim ? 'âœ“ ë°›ì¹¨ ìˆìŒ' : 'âœ— ë°›ì¹¨ ì—†ìŒ'}
                    </span>
                </div>
                ${josaPairs.map(pair => `
                    <div class="josa-demo-item">
                        <span class="label">${pair.label}</span>
                        <span class="example">
                            <span class="highlight">${demo.examples[pair.key]}</span>
                        </span>
                    </div>
                `).join('')}
            `;
        }

        // ============================================
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        // ============================================
        function setupDropZone(element, type, index = null) {
            if (!element) return;

            element.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                element.classList.add('dragover');
            });

            element.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                element.classList.add('dragover');
            });

            element.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                element.classList.remove('dragover');
            });

            element.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                element.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    // HEIC íŒŒì¼ì´ê±°ë‚˜ ì¼ë°˜ ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬
                    if (file.type.startsWith('image/') || isHeicFile(file)) {
                        handleDroppedFile(file, type, index);
                    }
                }
            });
        }

        // HEIC íŒŒì¼ í™•ì¸
        function isHeicFile(file) {
            const name = file.name.toLowerCase();
            return name.endsWith('.heic') || name.endsWith('.heif');
        }

        // HEICë¥¼ JPEGë¡œ ë³€í™˜
        async function convertHeicToJpeg(file) {
            if (!isHeicFile(file)) return file;

            try {
                showToast('HEIC ë³€í™˜ ì¤‘...');
                const blob = await heic2any({
                    blob: file,
                    toType: 'image/jpeg',
                    quality: 0.9
                });
                return new File([blob], file.name.replace(/\.heic$/i, '.jpg'), { type: 'image/jpeg' });
            } catch (error) {
                console.error('HEIC ë³€í™˜ ì‹¤íŒ¨:', error);
                showToast('HEIC ë³€í™˜ ì‹¤íŒ¨. ë‹¤ë¥¸ í˜•ì‹ì„ ì‹œë„í•˜ì„¸ìš”.');
                return null;
            }
        }

        // ============================================
        // ë°°ê²½ ì œê±° API
        // ============================================
        async function removeBackground(imageSource) {
            // imageSourceê°€ URL ê²½ë¡œì¸ ê²½ìš° fetchë¡œ ê°€ì ¸ì˜¤ê¸°
            let file;
            if (typeof imageSource === 'string') {
                try {
                    const response = await fetch(imageSource);
                    const blob = await response.blob();
                    const filename = imageSource.split('/').pop();
                    file = new File([blob], filename, { type: blob.type });
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                    throw new Error('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else {
                file = imageSource;
            }

            const formData = new FormData();
            formData.append('file', file);

            // ë©”ì¸ ì„œë²„ ì‹œë„
            try {
                const response = await fetch(`${SERVER_CONFIG.MAIN_URL}/remove-bg?max_size=1440&model=portrait`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    return URL.createObjectURL(blob);
                }
            } catch (e) {
                console.log('ë©”ì¸ ì„œë²„ ì‹¤íŒ¨, ë°±ì—… ì„œë²„ ì‹œë„...');
            }

            // ë°±ì—… ì„œë²„ ì‹œë„
            try {
                const response = await fetch(`${SERVER_CONFIG.BACKUP_URL}/remove-bg?max_size=1440&model=portrait`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    return URL.createObjectURL(blob);
                }
            } catch (e) {
                console.error('ë°±ì—… ì„œë²„ë„ ì‹¤íŒ¨:', e);
            }

            throw new Error('ë°°ê²½ ì œê±° ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ëª¨ë“  ì‚¬ì§„ ë°°ê²½ ì œê±° ì²˜ë¦¬ (ê¸°ì¡´ ë²„ì „ - ë¯¸ì‚¬ìš©)
        async function processAllPhotosForBackgroundRemoval() {
            await processAllPhotosWithLiveUpdate();
        }

        // ë°°ê²½ ì œê±°í•˜ë©´ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì±… ì—…ë°ì´íŠ¸
        async function processAllPhotosWithLiveUpdate() {
            const total = 1 + state.objects.length; // ì•„ì´ ì‚¬ì§„ + ë¬¼ê±´ë“¤
            let processed = 0;

            try {
                // ì•„ì´ ì‚¬ì§„ ë°°ê²½ ì œê±°
                if (state.childPhoto) {
                    showToast(`ì•„ì´ ì‚¬ì§„ ë°°ê²½ ì œê±° ì¤‘... (${processed}/${total})`);
                    try {
                        const result = await removeBackground(state.childPhoto);
                        state.childPhotoNoBg = result;
                        processed++;
                        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸!
                        updateBookPreview();
                        showToast(`ì•„ì´ ì‚¬ì§„ ì™„ë£Œ! (${processed}/${total})`);
                    } catch (e) {
                        console.error('ì•„ì´ ì‚¬ì§„ ë°°ê²½ ì œê±° ì‹¤íŒ¨:', e);
                        state.childPhotoNoBg = state.childPhoto;
                        processed++;
                    }
                }

                // ë¬¼ê±´ ì‚¬ì§„ë“¤ ë°°ê²½ ì œê±° - ìˆœì°¨ ì²˜ë¦¬í•˜ë©° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                for (let i = 0; i < state.objects.length; i++) {
                    const obj = state.objects[i];
                    if (obj.photo) {
                        showToast(`${obj.name} ë°°ê²½ ì œê±° ì¤‘... (${processed}/${total})`);
                        try {
                            const result = await removeBackground(obj.photo);
                            obj.photoNoBg = result;
                            processed++;
                            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸!
                            updateBookPreview();
                            showToast(`${obj.name} ì™„ë£Œ! (${processed}/${total})`);
                        } catch (e) {
                            console.error(`ë¬¼ê±´ ${i + 1} ë°°ê²½ ì œê±° ì‹¤íŒ¨:`, e);
                            obj.photoNoBg = obj.photo;
                            processed++;
                        }
                    } else {
                        processed++;
                    }
                }

                return true;
            } catch (error) {
                console.error('ë°°ê²½ ì œê±° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showToast('ë°°ê²½ ì œê±° ì‹¤íŒ¨. ì›ë³¸ ì‚¬ì§„ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
                return false;
            }
        }

        async function handleDroppedFile(file, type, index) {
            // HEIC íŒŒì¼ì´ë©´ ë³€í™˜
            let processedFile = file;
            if (isHeicFile(file)) {
                processedFile = await convertHeicToJpeg(file);
                if (!processedFile) return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'child') {
                    state.childPhoto = e.target.result;
                    updateChildPhotoUI(e.target.result);
                } else if (type === 'object' && index !== null) {
                    state.objects[index].photo = e.target.result;
                    renderObjectInputs();
                } else if (type === 'family' && index !== null) {
                    const member = state.familyMembers.find(m => m.id === index);
                    if (member) {
                        member.photo = e.target.result;
                        renderFamilyGrid();
                    }
                }
            };
            reader.readAsDataURL(processedFile);
        }

        function updateChildPhotoUI(dataUrl) {
            const uploadDiv = document.getElementById('childPhotoUpload');
            uploadDiv.classList.add('has-image');
            uploadDiv.innerHTML = `
                <input type="file" id="childPhoto" accept="image/*">
                <img src="${dataUrl}" alt="ì•„ì´ ì‚¬ì§„">
            `;
            document.getElementById('childPhoto').addEventListener('change', (e) => {
                handlePhotoUpload(e, 'child');
            });
            setupDropZone(uploadDiv, 'child');
        }

        // ============================================
        // UI ë Œë”ë§
        // ============================================
        function renderObjectInputs() {
            const container = document.getElementById('objectsContainer');
            container.innerHTML = state.objects.map((obj, idx) => `
                <div class="object-card">
                    <div class="card-header">
                        <span>ë¬¼ê±´ ${idx + 1}</span>
                        <span>${obj.emoji}</span>
                    </div>
                    <div class="form-group object-name">
                        <input type="text"
                               placeholder="ë¬¼ê±´ ì´ë¦„"
                               value="${obj.name}"
                               onchange="updateObjectName(${idx}, this.value)">
                    </div>
                    <div class="photo-upload ${obj.photo ? 'has-image' : ''}"
                         data-type="object" data-index="${idx}"
                         onclick="document.getElementById('objectPhoto${idx}').click()">
                        <input type="file" id="objectPhoto${idx}" accept="image/*"
                               onchange="handleObjectPhoto(${idx}, event)">
                        ${obj.photo
                            ? `<img src="${obj.photo}" alt="${obj.name}">`
                            : '<span class="upload-text">ì‚¬ì§„ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</span>'}
                    </div>
                    <div class="josa-toggle">
                        <button class="josa-btn ${obj.josaMode === 'friend' ? 'active' : ''}"
                                onclick="updateObjectJosaMode(${idx}, 'friend')" title="ì¹œêµ¬ì²˜ëŸ¼ ë¶€ë¥´ê¸°">
                            ğŸ§¸ ì¹œêµ¬
                        </button>
                        <button class="josa-btn ${obj.josaMode === 'object' ? 'active' : ''}"
                                onclick="updateObjectJosaMode(${idx}, 'object')" title="ì‚¬ë¬¼ì²˜ëŸ¼ ë¶€ë¥´ê¸°">
                            ğŸ“¦ ì‚¬ë¬¼
                        </button>
                    </div>
                    <div class="josa-preview">
                        "${objectVocative(obj.name, obj.josaMode)}, ë„ˆëŠ” ë­˜ ì¢‹ì•„í•´?"
                    </div>
                </div>
            `).join('');

            // ê° ë¬¼ê±´ ì‚¬ì§„ ì˜ì—­ì— ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            container.querySelectorAll('.photo-upload').forEach((el, idx) => {
                setupDropZone(el, 'object', idx);
            });
        }

        function renderFamilyGrid() {
            const grid = document.getElementById('familyGrid');
            grid.innerHTML = FAMILY_OPTIONS.map(member => `
                <div class="family-member ${state.familyMembers.find(m => m.id === member.id) ? 'selected' : ''}"
                     onclick="toggleFamilyMember('${member.id}')">
                    <div class="emoji">${member.emoji}</div>
                    <div class="relation">${member.relation}</div>
                    <div class="photo-slot" id="familyPhoto_${member.id}">
                        ${getFamilyPhotoHTML(member.id)}
                    </div>
                </div>
            `).join('');
        }

        function getFamilyPhotoHTML(memberId) {
            const member = state.familyMembers.find(m => m.id === memberId);
            if (member && member.photo) {
                return `<img src="${member.photo}" alt="${member.relation}">`;
            }
            return '';
        }

        function renderThumbnails() {
            const container = document.getElementById('thumbnails');
            const totalPages = 24;

            container.innerHTML = '';
            for (let i = 0; i < totalPages; i += 2) {
                const thumb = document.createElement('div');
                thumb.className = `thumbnail ${state.currentSpread === i / 2 ? 'active' : ''}`;
                thumb.textContent = `${i + 1}-${i + 2}`;
                thumb.onclick = () => goToSpread(i / 2);
                container.appendChild(thumb);
            }
        }

        // ============================================
        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        // ============================================
        function updateObjectName(index, value) {
            state.objects[index].name = value;
        }

        function updateObjectJosaMode(index, mode) {
            state.objects[index].josaMode = mode;
            renderObjectInputs();
        }

        async function handleObjectPhoto(index, event) {
            let file = event.target.files[0];
            if (file) {
                // HEIC ë³€í™˜
                if (isHeicFile(file)) {
                    file = await convertHeicToJpeg(file);
                    if (!file) return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    state.objects[index].photo = e.target.result;
                    renderObjectInputs();
                };
                reader.readAsDataURL(file);
            }
        }

        async function handlePhotoUpload(event, type) {
            let file = event.target.files[0];
            if (file) {
                // HEIC ë³€í™˜
                if (isHeicFile(file)) {
                    file = await convertHeicToJpeg(file);
                    if (!file) return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    if (type === 'child') {
                        state.childPhoto = e.target.result;
                        updateChildPhotoUI(e.target.result);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleFamilyMember(memberId) {
            const existingIndex = state.familyMembers.findIndex(m => m.id === memberId);

            if (existingIndex >= 0) {
                state.familyMembers.splice(existingIndex, 1);
            } else {
                const memberInfo = FAMILY_OPTIONS.find(m => m.id === memberId);
                state.familyMembers.push({
                    ...memberInfo,
                    photo: null
                });
            }

            renderFamilyGrid();
        }

        // ============================================
        // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜
        // ============================================
        function prevSpread() {
            if (state.currentSpread > 0) {
                state.currentSpread--;
                renderSpread();
                renderThumbnails();
            }
        }

        function nextSpread() {
            if (state.currentSpread < 11) {
                state.currentSpread++;
                renderSpread();
                renderThumbnails();
            }
        }

        function goToSpread(spreadIndex) {
            state.currentSpread = spreadIndex;
            renderSpread();
            renderThumbnails();
        }

        // ============================================
        // ì±… ìƒì„± - Master Schema ê¸°ë°˜
        // ============================================
        async function generateBook() {
            state.childName = document.getElementById('childFirstName').value || 'ì•„ì´';

            // ë¨¼ì € ì›ë³¸ ì‚¬ì§„ìœ¼ë¡œ ì±… ìƒì„± (ì¦‰ì‹œ ë³´ì—¬ì£¼ê¸°)
            state.currentSpread = 0;
            updateBookPreview();
            showToast('ë™í™”ì±… ìƒì„± ì‹œì‘! ë°°ê²½ ì œê±° ì¤‘...');

            // ë°°ê²½ ì œê±°ë¥¼ í•˜ë©´ì„œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
            await processAllPhotosWithLiveUpdate();

            showToast('ë™í™”ì±…ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ì‹¤ì‹œê°„ ì±… í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
        function updateBookPreview() {
            const storyBoard = generateStoryBoard(THEME_CONFIG, state);
            state.generatedBook = storyBoard;
            renderSpread();
            renderThumbnails();
            document.getElementById('schemaInfo').textContent =
                JSON.stringify(storyBoard, null, 2);
        }

        // ============================================
        // StoryBoard ìƒì„± í•¨ìˆ˜ (í•µì‹¬ ë¡œì§)
        // ============================================
        function generateStoryBoard(theme, userData) {
            const pages = [];
            const childName = userData.childName;
            const objects = userData.objects;
            const family = userData.familyMembers;

            // ê° í˜ì´ì§€ êµ¬ì¡°ì— ë”°ë¼ ìƒì„±
            theme.pageStructure.forEach((pageConfig) => {
                const pageData = {
                    pageNumber: pageConfig.page,
                    type: pageConfig.type,
                    content: {}
                };

                switch (pageConfig.type) {
                    case 'title':
                        const titleObjData = objects[0];
                        const titleObj = titleObjData?.name || 'ë¬¼ê±´';
                        const titleMode = titleObjData?.josaMode || 'friend';
                        pageData.content = {
                            text: `ë‚˜ëŠ” ${objectWithJosa(titleObj, 'ë¥¼', titleMode)} ì¢‹ì•„í•´`,
                            childName: childName
                        };
                        break;

                    case 'intro':
                        const introObjData = objects[0];
                        const introObj = introObjData?.name || 'ì´ê²ƒ';
                        const introMode = introObjData?.josaMode || 'friend';
                        pageData.content = {
                            text: `${withJosa(childName, 'ì•¼')},\në„ˆëŠ” ë­˜ ì¢‹ì•„í•´?`,
                            image: userData.childPhotoNoBg || userData.childPhoto,
                            speechBubble: `ë‚˜ëŠ” ${objectWithJosa(introObj, 'ë¥¼', introMode)} ì¢‹ì•„í•´!`
                        };
                        break;

                    case 'chain_question':
                        const qIdx = pageConfig.chainIndex;
                        const actor = objects[qIdx];
                        const actorMode = actor?.josaMode || 'friend';
                        // í˜¸ì¹­(Vocative): friendë©´ "í† ë¼ì•¼/ë¡œë´‡ì•„", objectë©´ "í† ë¼/ë¡œë´‡"
                        const vocative = objectVocative(actor?.name || 'ìºë¦­í„°', actorMode);
                        pageData.content = {
                            text: `${vocative},\në„ˆëŠ” ë­˜ ì¢‹ì•„í•´?`,
                            character: {
                                ...actor,
                                photo: actor?.photoNoBg || actor?.photo
                            },
                            isQuestion: true
                        };
                        break;

                    case 'chain_answer':
                        const aIdx = pageConfig.chainIndex;
                        const answerer = objects[aIdx];
                        const target = objects[aIdx + 1];
                        // ë§ˆì§€ë§‰ ë¬¼ê±´ì´ë©´ íƒ€ê²Ÿì€ ì•„ì´ (ì‚¬ëŒì´ë¯€ë¡œ ì¼ë°˜ ì¡°ì‚¬ ì‚¬ìš©)
                        const isLastObject = aIdx === objects.length - 1;
                        const targetName = target ? target.name : childName;
                        const targetMode = target?.josaMode || 'friend';
                        const answerText = isLastObject
                            ? `ë‚˜ëŠ” ${withJosa(targetName, 'ë¥¼')} ì¢‹ì•„í•´.`  // ì•„ì´ëŠ” ì‚¬ëŒì´ë¯€ë¡œ ì¼ë°˜ ì¡°ì‚¬
                            : `ë‚˜ëŠ” ${objectWithJosa(targetName, 'ë¥¼', targetMode)} ì¢‹ì•„í•´.`;  // ê° ë¬¼ê±´ì˜ ê°œë³„ ëª¨ë“œ ì ìš©
                        pageData.content = {
                            text: answerText,
                            character: {
                                ...answerer,
                                photo: answerer?.photoNoBg || answerer?.photo
                            },
                            target: target ? {
                                ...target,
                                photo: target?.photoNoBg || target?.photo
                            } : { name: childName },
                            isAnswer: true
                        };
                        break;

                    case 'climax_question':
                        const lastObj = objects[objects.length - 1];
                        const lastObjMode = lastObj?.josaMode || 'friend';
                        pageData.content = {
                            text: `ê·¸ëŸ¼ ${objectWithJosa(lastObj?.name || 'ìºë¦­í„°', 'ëŠ”', lastObjMode)}\në­˜ ì œì¼ ì¢‹ì•„í•˜ëƒë©´...`,
                            character: lastObj
                        };
                        break;

                    case 'climax_heart':
                        pageData.content = {
                            visual: 'heart',
                            text: 'ë‘ê·¼ë‘ê·¼...'
                        };
                        break;

                    case 'child_reveal':
                        pageData.content = {
                            text: `ë°”ë¡œ ${childName}!`,
                            image: userData.childPhotoNoBg || userData.childPhoto,
                            highlight: true
                        };
                        break;

                    case 'all_together':
                        pageData.content = {
                            text: 'ëª¨ë‘ í•¨ê»˜!',
                            characters: objects.map(obj => ({
                                ...obj,
                                photo: obj.photoNoBg || obj.photo
                            })),
                            childImage: userData.childPhotoNoBg || userData.childPhoto
                        };
                        break;

                    case 'family_intro':
                        pageData.content = {
                            text: `ìš°ë¦¬ë„ ${withJosa(childName, 'ë¥¼')} ì¢‹ì•„í•´!`,
                            exclamation: 'ì ê¹ë§Œ!'
                        };
                        break;

                    case 'family_grid':
                    case 'family_grid_2':
                        // ë™ì  ê°€ì¡± ë ˆì´ì•„ì›ƒ
                        pageData.content = createFamilyLayout(family, pageConfig.type === 'family_grid' ? 0 : 1);
                        break;

                    case 'child_loves_family':
                    case 'child_loves_family_2':
                        const relations = family.map(m => m.relation).join(', ');
                        // ë§ˆì§€ë§‰ ê°€ì¡± êµ¬ì„±ì›ì— ë§ì¶° ì¡°ì‚¬ ê²°ì •
                        const lastRelation = family.length > 0 ? family[family.length - 1].relation : '';
                        const relationsWithJosa = relations + josa(lastRelation, 'ë¥¼');
                        pageData.content = {
                            text: `ë‚˜ë„ ${relationsWithJosa} ì¢‹ì•„í•´!`,
                            childImage: userData.childPhoto
                        };
                        break;

                    case 'who_best':
                        pageData.content = {
                            text: 'ëˆ„ê°€ ì œì¼ ì¢‹ì•„?',
                            childImage: userData.childPhoto
                        };
                        break;

                    case 'secret':
                        pageData.content = {
                            text: `ë¹„ë°€ì¸ë°...\n${withJosa(childName, 'ê°€')} ì œì¼ ì¢‹ì•„í•˜ëŠ” ê±´\në°”ë¡œ ë„ˆì•¼!`,
                            isSecret: true
                        };
                        break;

                    case 'character_intro':
                    case 'character_intro_2':
                        pageData.content = {
                            characters: objects,
                            text: 'ë“±ì¥ì¸ë¬¼ ì†Œê°œ'
                        };
                        break;

                    case 'credits':
                        pageData.content = {
                            text: `${childName}ì˜ íŠ¹ë³„í•œ ì´ì•¼ê¸°`,
                            copyright: 'ë¼ì´ì–¸ë¶'
                        };
                        break;
                }

                pages.push(pageData);
            });

            return {
                themeId: theme.themeId,
                childName: childName,
                createdAt: new Date().toISOString(),
                pages: pages,
                familyLayout: calculateFamilyLayout(family.length)
            };
        }

        // ============================================
        // ë™ì  ê°€ì¡± ë ˆì´ì•„ì›ƒ ì‹œìŠ¤í…œ
        // ============================================
        function createFamilyLayout(familyMembers, pageIndex) {
            const layout = calculateFamilyLayout(familyMembers.length);
            const startIdx = pageIndex * layout.perPage;
            const endIdx = Math.min(startIdx + layout.perPage, familyMembers.length);
            const membersForPage = familyMembers.slice(startIdx, endIdx);

            return {
                layout: layout.type,
                columns: layout.columns,
                rows: layout.rows,
                members: membersForPage
            };
        }

        function calculateFamilyLayout(memberCount) {
            // ê°€ì¡± ìˆ˜ì— ë”°ë¥¸ ë™ì  ë ˆì´ì•„ì›ƒ
            if (memberCount <= 2) {
                return { type: '1x2', columns: 2, rows: 1, perPage: 2 };
            } else if (memberCount <= 4) {
                return { type: '2x2', columns: 2, rows: 2, perPage: 4 };
            } else if (memberCount <= 6) {
                return { type: '2x3', columns: 3, rows: 2, perPage: 6 };
            } else {
                return { type: '3x3', columns: 3, rows: 3, perPage: 9 };
            }
        }

        // ============================================
        // ìŠ¤í”„ë ˆë“œ ë Œë”ë§
        // ============================================
        function renderSpread() {
            const leftPageNum = state.currentSpread * 2 + 1;
            const rightPageNum = state.currentSpread * 2 + 2;

            document.getElementById('pageIndicator').textContent =
                `${leftPageNum}-${rightPageNum} / 24`;

            if (state.generatedBook) {
                const leftPage = state.generatedBook.pages[leftPageNum - 1];
                const rightPage = state.generatedBook.pages[rightPageNum - 1];

                renderPage('leftPage', leftPage, leftPageNum);
                renderPage('rightPage', rightPage, rightPageNum);
            } else {
                // ê¸°ë³¸ í”Œë ˆì´ìŠ¤í™€ë”
                document.getElementById('leftPage').innerHTML = `
                    <div class="page-content">
                        <p style="color: #999;">í˜ì´ì§€ ${leftPageNum}</p>
                    </div>
                    <span class="page-number">${leftPageNum}</span>
                `;
                document.getElementById('rightPage').innerHTML = `
                    <div class="page-content">
                        <p style="color: #999;">í˜ì´ì§€ ${rightPageNum}</p>
                    </div>
                    <span class="page-number">${rightPageNum}</span>
                `;
            }
        }

        function renderPage(elementId, pageData, pageNum) {
            const el = document.getElementById(elementId);

            if (!pageData) {
                el.innerHTML = `<div class="page-content"><p>ë¹ˆ í˜ì´ì§€</p></div>`;
                return;
            }

            let html = '<div class="page-content">';

            switch (pageData.type) {
                case 'title':
                    html += `
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">
                            ${pageData.content.text}
                        </div>
                        <div style="margin-top: 20px; font-size: 1.2rem;">
                            <span class="child-name">${pageData.content.childName}</span>ì˜ ì´ì•¼ê¸°
                        </div>
                    `;
                    break;

                case 'intro':
                    html += `
                        <div class="dialogue">${pageData.content.text}</div>
                        ${pageData.content.image
                            ? `<img src="${pageData.content.image}" style="width: 120px; height: 120px; margin-top: 16px; object-fit: contain;">`
                            : '<div class="character-img">ğŸ‘¶</div>'}
                        <div style="background: var(--accent); padding: 10px 16px; border-radius: 20px; margin-top: 12px; font-size: 0.9rem;">
                            ${pageData.content.speechBubble}
                        </div>
                    `;
                    break;

                case 'chain_question':
                    const qChar = pageData.content.character;
                    html += `
                        ${qChar?.photo
                            ? `<img src="${qChar.photo}" style="width: 100px; height: 100px; object-fit: contain; margin-bottom: 12px;">`
                            : `<div class="character-img">${qChar?.emoji || 'â“'}</div>`}
                        <div class="dialogue">${pageData.content.text.replace('\n', '<br>')}</div>
                    `;
                    break;

                case 'chain_answer':
                    const aChar = pageData.content.character;
                    html += `
                        ${aChar?.photo
                            ? `<img src="${aChar.photo}" style="width: 100px; height: 100px; object-fit: contain; margin-bottom: 12px;">`
                            : `<div class="character-img">${aChar?.emoji || 'ğŸ’¬'}</div>`}
                        <div class="dialogue">${pageData.content.text}</div>
                    `;
                    break;

                case 'climax_heart':
                    html += `
                        <div style="font-size: 5rem;">â¤ï¸</div>
                        <div class="dialogue">${pageData.content.text}</div>
                    `;
                    break;

                case 'child_reveal':
                    html += `
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">
                            ${pageData.content.text}
                        </div>
                        ${pageData.content.image
                            ? `<img src="${pageData.content.image}" style="width: 140px; height: 140px; margin-top: 16px; object-fit: contain;">`
                            : '<div class="character-img" style="border: 4px solid var(--primary);">ğŸ‘¶</div>'}
                    `;
                    break;

                case 'family_grid':
                case 'family_grid_2':
                    const members = pageData.content.members || [];
                    const cols = pageData.content.columns || 2;
                    html += `
                        <div style="display: grid; grid-template-columns: repeat(${cols}, 1fr); gap: 10px; width: 100%;">
                            ${members.map(m => `
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem;">${m.emoji}</div>
                                    <div style="font-size: 0.85rem;">${m.relation}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;

                case 'secret':
                    html += `
                        <div style="font-size: 1.1rem; line-height: 2; color: var(--dark);">
                            ${pageData.content.text.replace(/\n/g, '<br>')}
                        </div>
                    `;
                    break;

                default:
                    html += `
                        <div class="dialogue">${pageData.content.text || pageData.type}</div>
                    `;
            }

            html += '</div>';
            html += `<span class="page-number">${pageNum}</span>`;

            el.innerHTML = html;
        }

        // ============================================
        // ìœ í‹¸ë¦¬í‹°
        // ============================================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ì´ˆê¸°í™” ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
