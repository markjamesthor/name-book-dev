<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>노미네 왕국 — Book Preview</title>
<style>
  /* ===== Font ===== */
  @font-face {
    font-family: 'BMDOHYEON';
    src: url('NAME/BMDOHYEON_ttf.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }

  /* ===== Reset & Base ===== */
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
    background: #fff;
    color: #1a1a1a;
    height: 100vh;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
  }

  /* ===== Top Bar (purple) ===== */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    background: #6c5ce7;
    flex-shrink: 0;
    position: relative;
  }
  .top-bar-right {
    display: flex; align-items: center; gap: 8px;
    position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
  }
  .guide-btn {
    background: #fff;
    border: none;
    border-radius: 8px;
    color: #6c5ce7;
    font-size: 12px;
    font-weight: 700;
    padding: 7px 16px;
    cursor: pointer;
    letter-spacing: 0.2px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .guide-btn:active { background: #f0eef9; }

  /* Bottom Sheet */
  .guide-modal {
    position: fixed; inset: 0;
    z-index: 9999;
    background: #fff;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transform: translateY(12px);
    transition: opacity 0.25s ease, transform 0.25s ease;
  }
  .guide-modal.active {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }
  .guide-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid #eee;
    flex-shrink: 0;
  }
  .guide-modal-header h2 {
    font-size: 16px;
    font-weight: 700;
    color: #222;
  }
  .guide-modal-close {
    background: #f0f0f0; border: none;
    font-size: 18px; color: #666;
    cursor: pointer;
    width: 36px; height: 36px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    line-height: 1;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  .guide-modal-close:active { background: #ddd; }
  .guide-modal-body {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 0 20px 32px;
    font-size: 14px;
    line-height: 1.8;
    color: #333;
  }
  .guide-modal-body h3 {
    font-size: 15px;
    font-weight: 700;
    color: #6c5ce7;
    margin: 20px 0 8px;
  }
  .guide-modal-body hr {
    border: none;
    border-top: 1px solid #eee;
    margin: 16px 0;
  }
  .guide-modal-body p {
    margin: 8px 0;
  }
  .guide-modal-body ul {
    padding-left: 18px;
    margin: 8px 0;
  }
  .guide-modal-body li {
    margin: 6px 0;
  }
  .guide-modal-body strong {
    color: #222;
  }
  /* ===== remove.bg Toggle ===== */
  .removebg-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    height: 28px;
    padding: 0 10px;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 14px;
    background: rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.7);
    font-size: 11px;
    font-family: inherit;
    cursor: pointer;
    flex-shrink: 0;
    white-space: nowrap;
    transition: border-color 0.2s, color 0.2s, background 0.2s;
  }
  .removebg-toggle.active {
    border-color: rgba(255,255,255,0.6);
    color: #fff;
    background: rgba(255,255,255,0.25);
  }
  .removebg-toggle .toggle-switch {
    width: 28px;
    height: 16px;
    border-radius: 8px;
    background: rgba(255,255,255,0.3);
    position: relative;
    transition: background 0.2s;
  }
  .removebg-toggle.active .toggle-switch {
    background: rgba(255,255,255,0.7);
  }
  .removebg-toggle .toggle-switch::after {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #fff;
    top: 2px;
    left: 2px;
    transition: transform 0.2s;
    opacity: 0.7;
  }
  .removebg-toggle.active .toggle-switch::after {
    transform: translateX(12px);
    opacity: 1;
  }

  /* ===== Person Selection Modal ===== */
  .person-selection-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0,0,0,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 20px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }
  .person-selection-modal.visible {
    opacity: 1;
    pointer-events: auto;
  }
  .person-selection-modal h3 {
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    margin: 0 0 4px;
    text-align: center;
  }
  .person-selection-modal canvas {
    border-radius: 8px;
    max-width: 100%;
  }
  .person-selection-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .person-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    border: 2px solid #666;
    border-radius: 12px;
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-size: 15px;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
  }
  .person-btn:active {
    transform: scale(0.95);
    background: rgba(255,255,255,0.2);
  }

  /* ===== Preview Area ===== */
  .preview-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px 0 4px;
    min-height: 0;
    position: relative;
  }

  .page-viewer-wrap {
    position: relative;
    width: 100%;
    max-width: 480px;
    flex: 1;
    min-height: 200px;
  }

  #page-viewer {
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: relative;
    background: transparent;
    touch-action: pan-y;
  }

  /* Page counter */
  .page-counter-bar {
    padding: 6px 0 2px;
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    color: #999;
    flex-shrink: 0;
  }

  /* ===== Carousel ===== */
  .carousel-track {
    display: flex;
    height: 100%;
    will-change: transform;
  }
  .carousel-slide {
    height: 100%;
    flex: none;
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 4px 20px rgba(0,0,0,0.12), 0 1px 4px rgba(0,0,0,0.08);
    -webkit-mask-image: -webkit-radial-gradient(white, black);
  }

  .slide-img-wrap {
    position: absolute;
    inset: 0;
    overflow: hidden;
    transform-origin: center center;
  }

  .page-bg-blur { display: none; }
  .page-bg-img {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
  }
  .page-bg-gradient {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
  }

  .page-text-overlay {
    position: absolute;
    left: 0; right: 0;
    padding: 24px 40px;
    text-align: center;
    z-index: 10;
    background: linear-gradient(180deg, rgba(0,0,0,0.55) 0%, rgba(0,0,0,0.3) 70%, transparent 100%);
  }
  .text-pos-top    { top: 0; }
  .text-pos-center { top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.35); }
  .text-pos-bottom { bottom: 0; background: linear-gradient(0deg, rgba(0,0,0,0.55) 0%, rgba(0,0,0,0.3) 70%, transparent 100%); }

  .page-story-text {
    font-family: 'Noto Serif KR', 'RIDIBatang', 'Batang', serif;
    font-size: 16px;
    line-height: 2.2;
    text-shadow: 0 1px 6px rgba(0,0,0,0.7);
    word-break: keep-all;
  }

  .carousel-slide + .carousel-slide {
    border-left: 3px solid #f5f5f5;
  }

  /* ===== Step Bar ===== */
  .step-bar {
    display: flex;
    align-items: stretch;
    padding: 0 16px;
    background: #fff;
    flex-shrink: 0;
    height: 44px;
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -4px 16px rgba(0,0,0,0.08);
    position: relative;
    z-index: 2;
  }
  .step-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    font-size: 13px;
    font-weight: 500;
    color: #aaa;
    cursor: pointer;
    transition: color 0.2s;
    border-bottom: 2.5px solid transparent;
  }
  .step-tab.active {
    color: #6c5ce7;
    font-weight: 700;
    border-bottom-color: #6c5ce7;
  }
  .step-tab .step-num {
    font-size: 11px;
    font-weight: 700;
    opacity: 0.5;
  }
  .step-tab.active .step-num { opacity: 0.8; }

  /* ===== Bottom Panel ===== */
  .bottom-panel {
    flex: 0 0 auto;
    background: #fff;
    overflow: hidden;
    min-height: 100px;
  }
  .step-content {
    display: none;
    padding: 12px 16px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    max-height: 25vh;
  }
  .step-content.active { display: block; }

  /* Step 0: Name inputs */
  .input-group { margin-bottom: 12px; }
  .input-group label {
    display: block;
    font-size: 12px;
    color: #888;
    margin-bottom: 4px;
    font-weight: 500;
  }
  .input-group input {
    width: 100%;
    padding: 10px 12px;
    background: #f8f8f8;
    border: 1.5px solid #e0e0e0;
    border-radius: 10px;
    color: #1a1a1a;
    font-size: 16px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
  }
  .input-group input:focus { border-color: #6c5ce7; }

  .version-switch { display: flex; gap: 6px; margin-top: 4px; }
  .version-btn {
    flex: 1;
    padding: 10px 8px;
    border: 1.5px solid #e0e0e0;
    border-radius: 10px;
    background: #f8f8f8;
    color: #888;
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-weight: 500;
  }
  .version-btn:hover { border-color: #6c5ce7; color: #555; }
  .version-btn.active {
    background: #6c5ce7;
    color: #fff;
    border-color: #6c5ce7;
    font-weight: 700;
  }

  /* Step 1: Thumbnails */
  .step-content-thumbs { padding: 12px 16px; }
  #thumbnail-strip {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 4px 0;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }
  #thumbnail-strip::-webkit-scrollbar { height: 4px; }
  #thumbnail-strip::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 2px; }
  #thumbnail-strip::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

  .thumb-wrap {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
  }
  .thumb {
    width: 72px; height: 56px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    position: relative;
    transition: border-color 0.2s, box-shadow 0.2s;
    background: #f0f0f0;
  }
  .thumb:hover { border-color: #ccc; }
  .thumb.active { border-color: #6c5ce7; box-shadow: 0 0 0 1px #6c5ce7, 0 2px 8px rgba(108,92,231,0.3); }
  .thumb img { width: 100%; height: 100%; object-fit: cover; }
  .thumb-gradient { width: 100%; height: 100%; }
  .thumb-label {
    position: absolute;
    bottom: 2px; right: 4px;
    font-size: 9px; font-weight: 700;
    color: rgba(255,255,255,0.9);
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
  }
  .thumb-need-photo {
    font-size: 9px;
    font-weight: 700;
    color: #e74c3c;
    white-space: nowrap;
  }
  .thumb-wrap:has(.thumb-delete) { position: relative; }
  .thumb-delete {
    position: absolute;
    top: -6px; right: -6px;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: #e74c3c;
    color: #fff;
    border: 2px solid #fff;
    font-size: 11px;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    padding: 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }
  .thumb-delete:hover { background: #c0392b; }
  .thumb-add {
    width: 72px; height: 56px;
    border-radius: 8px;
    border: 2px dashed #ccc;
    background: #f8f8f8;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: border-color 0.2s, background 0.2s;
  }
  .thumb-add:hover { border-color: #6c5ce7; background: #f0eeff; }
  .thumb-add svg { width: 20px; height: 20px; color: #aaa; }
  .thumb-add:hover svg { color: #6c5ce7; }

  /* Album frame picker modal */
  .album-picker-backdrop {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0,0,0,0.5);
    display: none;
  }
  .album-picker-backdrop.open { display: block; }
  .album-picker-sheet {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 101;
    background: #fff;
    border-radius: 16px 16px 0 0;
    padding: 0 20px 20px;
    padding-bottom: max(20px, env(safe-area-inset-bottom));
    transform: translateY(100%);
    transition: transform 0.3s ease-out;
  }
  .album-picker-backdrop.open .album-picker-sheet { transform: translateY(0); }
  .album-picker-handle {
    width: 36px; height: 4px;
    background: #ddd; border-radius: 2px;
    margin: 10px auto 14px;
  }
  .album-picker-title {
    text-align: center;
    font-size: 14px; color: #666;
    margin-bottom: 12px;
  }
  .album-picker-options {
    display: flex; flex-direction: column; gap: 10px;
  }
  .album-picker-opt {
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 14px;
    font-size: 14px; font-weight: 500;
    color: #333;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
  }
  .album-picker-opt:hover { background: #ede8ff; border-color: #6c5ce7; }
  .album-picker-opt:active { transform: scale(0.98); }

  /* Step 2: Photo controls */
  .step-content-photo.active {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  /* ===== Cover Page ===== */
  .cover-layout {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 24px;
    z-index: 10;
    background: rgba(0,0,0,0.35);
  }

  .cover-hint-text {
    text-align: center;
    color: rgba(255,255,255,0.7);
    font-size: 13px;
    line-height: 1.6;
  }

  .cover-title {
    font-family: 'Noto Serif KR', 'Batang', serif;
    font-size: 30px;
    font-weight: 700;
    color: #f0d060;
    text-shadow: 0 2px 12px rgba(240, 208, 96, 0.4), 0 0 40px rgba(0,0,0,0.8);
    letter-spacing: 2px;
    text-align: center;
  }
  .cover-subtitle {
    font-family: 'Noto Serif KR', 'Batang', serif;
    font-size: 15px;
    color: rgba(255,255,255,0.85);
    text-align: center;
    line-height: 1.8;
    text-shadow: 0 1px 8px rgba(0,0,0,0.8);
  }
  .cover-title-inline {
    font-weight: 700;
    color: #f0d060;
    text-shadow: 0 2px 8px rgba(240, 208, 96, 0.3);
  }

  .cover-photo-zone {
    width: 160px;
    height: 200px;
    border: 2px dashed rgba(108,92,231,0.4);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    background: rgba(108,92,231,0.05);
  }
  .cover-photo-zone:hover {
    border-color: #6c5ce7;
    background: rgba(108,92,231,0.1);
  }
  .cover-photo-zone .upload-icon { font-size: 36px; opacity: 0.5; }
  .cover-photo-zone .upload-text { font-size: 13px; color: #888; }

  .cover-front-wrap {
    position: absolute;
    overflow: hidden;
    z-index: 2;
    pointer-events: none;
  }
  .cover-front-img {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: auto;
  }

  .cover-child-wrap {
    position: absolute;
    overflow: hidden;
    z-index: 1;
  }
  .cover-child-wrap.nudge {
    animation: childNudge 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes childNudge {
    0% { transform: translateY(0); }
    40% { transform: translateY(-12px); }
    100% { transform: translateY(0); }
  }
  .cover-child-img {
    position: absolute;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  .cover-drag-hint {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 22%;
    z-index: 15;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    color: #fff;
    font-size: 12px;
    font-weight: 500;
    padding: 6px 14px;
    border-radius: 999px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    animation: dragHintFade 3s ease 0.5s forwards;
  }
  @keyframes dragHintFade {
    0% { opacity: 0; transform: translateX(-50%) translateY(4px); }
    12% { opacity: 1; transform: translateX(-50%) translateY(0); }
    70% { opacity: 1; transform: translateX(-50%) translateY(0); }
    100% { opacity: 0; transform: translateX(-50%) translateY(-4px); }
  }

  /* Cover controls in bottom panel */
  .cover-upload-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    max-width: 300px;
    padding: 14px 20px;
    border: 1.5px dashed #ccc;
    border-radius: 12px;
    background: #f8f8f8;
    color: #888;
    font-size: 14px;
    font-family: inherit;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
  }
  .cover-upload-btn:hover {
    border-color: #6c5ce7;
    background: rgba(108,92,231,0.05);
    color: #6c5ce7;
  }

  .cover-action-menu {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }
  .cover-action-btn {
    background: #f0f0f0;
    color: #555;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 20px;
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.15s, color 0.15s, border-color 0.15s;
  }
  .cover-action-btn:hover, .cover-action-btn:active {
    background: #e8e4ff;
    color: #6c5ce7;
    border-color: #6c5ce7;
  }

  /* Position edit */
  .cover-pos-hint {
    font-size: 12px;
    color: #6c5ce7;
    font-weight: 600;
  }
  .cover-pos-buttons { display: flex; gap: 10px; }
  .cover-pos-btn {
    background: transparent;
    color: #888;
    border: 1px solid #ddd;
    border-radius: 16px;
    padding: 6px 18px;
    font-size: 12px;
    font-family: inherit;
    cursor: pointer;
    transition: color 0.15s, border-color 0.15s;
  }
  .cover-pos-btn:hover, .cover-pos-btn:active {
    color: #6c5ce7;
    border-color: #6c5ce7;
  }
  .cover-pos-done {
    color: #6c5ce7;
    border-color: #6c5ce7;
  }

  .cover-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }
  .cover-spinner {
    width: 36px;
    height: 36px;
    border: 3px solid rgba(108,92,231,0.15);
    border-top-color: #6c5ce7;
    border-radius: 50%;
    animation: cover-spin 0.8s linear infinite;
  }
  @keyframes cover-spin {
    to { transform: rotate(360deg); }
  }
  .cover-loading-text {
    font-size: 13px;
    color: #fff;
    font-weight: bold;
  }
  .cover-error-text {
    font-size: 13px;
    color: #ffb3b3;
    text-align: center;
    line-height: 1.4;
    white-space: pre-line;
    max-width: 90%;
  }
  .cover-retry-btn {
    padding: 8px 20px;
    border: none;
    border-radius: 8px;
    background: #6c5ce7;
    color: #fff;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }
  .cover-retry-btn:active {
    opacity: 0.8;
  }

  .cover-top-title {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
    text-align: center;
    padding: 36px 20px 16px;
    background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.25) 60%, transparent 100%);
  }
  .cover-top-title-text {
    font-family: 'BMDOHYEON', sans-serif;
    font-size: 28px;
    color: white;
    text-shadow: 0 2px 12px rgba(0,0,0,0.7);
    letter-spacing: 1px;
  }

  .model-loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 36px;
    height: 36px;
    border: 3px solid rgba(108,92,231,0.3);
    border-top-color: #6c5ce7;
    border-radius: 50%;
    animation: model-spin 0.8s linear infinite;
  }
  @keyframes model-spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  .cover-model-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 14px 16px 12px;
    z-index: 20;
    pointer-events: none;
  }
  .cover-model-overlay .model-toggle,
  .cover-model-overlay .model-toggle-hint {
    pointer-events: auto;
  }
  .cover-model-overlay .model-toggle-hint {
    color: rgba(255,255,255,0.75);
    text-shadow: 0 1px 4px rgba(0,0,0,0.6);
    font-size: 11px;
  }
  .model-toggle-large {
    background: rgba(200,200,200,0.35);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 3px !important;
    gap: 6px;
    border-radius: 999px !important;
    position: relative;
  }
  .model-toggle-indicator {
    position: absolute;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #6c5ce7;
    box-shadow: 0 2px 8px rgba(108,92,231,0.5);
    top: 3px;
    left: 3px;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 0;
  }
  .model-toggle-large .model-toggle-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    font-size: 16px;
    font-weight: 700;
    color: rgba(0,0,0,0.7);
    transition: color 0.3s;
    position: relative;
    z-index: 1;
    background: transparent;
  }
  .model-toggle-large .model-toggle-option.active {
    color: #fff;
    background: transparent;
  }

  .model-toggle-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    width: 100%;
  }
  .model-toggle-hint {
    font-size: 12px;
    color: #888;
    font-weight: 500;
    white-space: nowrap;
  }
  .toggle-toast {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 8px;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    color: #fff;
    font-size: 12px;
    font-weight: 500;
    padding: 6px 14px;
    border-radius: 999px;
    white-space: nowrap;
    pointer-events: none;
    animation: toggleToastFade 1.8s ease forwards;
  }
  @keyframes toggleToastFade {
    0% { opacity: 0; transform: translateX(-50%) translateY(4px); }
    15% { opacity: 1; transform: translateX(-50%) translateY(0); }
    70% { opacity: 1; }
    100% { opacity: 0; }
  }
  .model-toggle {
    display: flex;
    background: #f0f0f0;
    border-radius: 20px;
    padding: 3px;
  }
  .model-toggle-option {
    padding: 6px 16px;
    border-radius: 17px;
    color: #aaa;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
  }
  .model-toggle-option.active {
    background: #6c5ce7;
    color: #fff;
  }
  .model-toggle-loading {
    opacity: 0.35;
    position: relative;
  }
  .model-toggle-loading.active {
    animation: toggle-pulse 1s ease-in-out infinite;
  }
  .model-toggle-failed {
    opacity: 0.2;
    pointer-events: none;
    text-decoration: line-through;
  }
  @keyframes toggle-pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 0.7; }
  }

  /* Candidate list */
  .candidate-list {
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .candidate-thumb {
    width: 52px;
    height: 52px;
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    border: 2.5px solid transparent;
    position: relative;
    transition: border-color 0.2s, box-shadow 0.2s;
    flex-shrink: 0;
  }
  .candidate-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .candidate-thumb.active {
    border-color: #6c5ce7;
    box-shadow: 0 0 0 1px #6c5ce7;
  }
  .candidate-thumb.processing::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.3);
  }
  .candidate-spinner {
    position: absolute;
    inset: 0;
    margin: auto;
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: cover-spin 0.8s linear infinite;
    z-index: 1;
  }
  .candidate-add {
    width: 52px;
    height: 52px;
    border-radius: 10px;
    border: 2px dashed #ccc;
    background: #f8f8f8;
    color: #aaa;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.2s, color 0.2s;
    flex-shrink: 0;
  }
  .candidate-add:hover {
    border-color: #6c5ce7;
    color: #6c5ce7;
  }

  .thumb-cover {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    font-weight: 700;
    color: rgba(240, 208, 96, 0.9);
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    letter-spacing: 0.5px;
    background: rgba(0,0,0,0.25);
  }

  /* ===== Story Settings Bottom Sheet ===== */
  .story-sheet-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 100;
  }
  .story-sheet-backdrop.open { display: block; }

  .story-sheet {
    position: fixed;
    left: 0; right: 0; bottom: 0;
    background: #fff;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -8px 30px rgba(0,0,0,0.15);
    z-index: 101;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    max-height: 70vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  .story-sheet.open {
    transform: translateY(0);
  }
  .story-sheet-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px 12px;
    border-bottom: 1px solid #eee;
    position: sticky;
    top: 0;
    background: #fff;
    border-radius: 20px 20px 0 0;
    z-index: 1;
  }
  .story-sheet-title {
    font-size: 16px;
    font-weight: 700;
    color: #1a1a1a;
  }
  .story-sheet-done {
    font-size: 15px;
    font-weight: 700;
    color: #6c5ce7;
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
  }
  .story-sheet-body {
    padding: 20px;
  }

  /* ===== Frame Page (Page 1) — uses album-style rendering ===== */
  .frame-page-zone {
    cursor: pointer;
  }

  /* ===== Epilogue Album (Frame Overlay) ===== */
  .album-page-container {
    position: absolute; inset: 0;
    z-index: 1;
  }
  .album-frame-zone {
    position: absolute;
    overflow: hidden;
    z-index: 1;
    cursor: pointer;
    transition: box-shadow 0.25s, transform 0.25s, filter 0.25s;
  }
  .album-frame-zone.selected {
    box-shadow: 0 0 0 4px rgba(212, 168, 83, 1), 0 0 20px rgba(212, 168, 83, 0.6);
    transform: scale(1.12);
    z-index: 8 !important;
    filter: brightness(1.15);
  }
  .album-frame-zone.drop-target {
    box-shadow: 0 0 0 3px rgba(212, 168, 83, 0.5);
  }
  .album-frame-zone img.album-photo {
    width: 100%; height: 100%;
    object-fit: cover;
    pointer-events: none;
    display: block;
  }
  .album-frame-overlay {
    position: absolute;
    inset: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 5;
  }
  .album-placeholder-icon {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.25);
    backdrop-filter: blur(2px);
  }
  .album-page-upload-btn {
    position: absolute;
    top: 6px; left: 50%; transform: translateX(-50%);
    z-index: 10;
    background: rgba(196, 163, 90, 0.9);
    color: #fff;
    border: none;
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    transition: all 0.2s;
  }
  .album-page-upload-btn:hover { background: rgba(168, 135, 46, 0.95); }
  .album-drag-ghost {
    position: fixed;
    pointer-events: none;
    z-index: 1000;
    opacity: 0.85;
    transform: translate(-50%, -50%) scale(0.5);
    border-radius: 8px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    transition: opacity 0.15s;
  }
  .album-hint {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: rgba(255,255,255,0.9);
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 999px;
    white-space: nowrap;
  }
  .frame-page-hint {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: rgba(255,255,255,0.9);
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 999px;
    white-space: nowrap;
  }
  .cover-touch-hint {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: rgba(255,255,255,0.9);
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 999px;
    white-space: nowrap;
    z-index: 20;
  }
  .cover-touch-hint-close {
    background: none;
    border: none;
    color: rgba(255,255,255,0.6);
    font-size: 16px;
    line-height: 1;
    cursor: pointer;
    padding: 0 2px;
  }
  .album-hint-close, .frame-page-hint-close {
    background: none;
    border: none;
    color: rgba(255,255,255,0.6);
    font-size: 16px;
    line-height: 1;
    cursor: pointer;
    padding: 0 2px;
  }

  /* ===== Mobile-first (모든 화면에서 모바일 레이아웃) ===== */
  body { height: 100dvh; }
  .top-bar { padding: 6px 12px; }
  .top-bar h1 { font-size: 14px; }

  .preview-area { padding: 4px 0 2px; }
  .carousel-slide { border-radius: 10px; box-shadow: none; }

  .carousel-slide {
    display: flex;
    flex-direction: column;
  }
  .carousel-slide + .carousel-slide {
    border-left: none;
  }
  .slide-img-wrap {
    position: relative;
    flex: none;
    width: 100%;
    aspect-ratio: 2592 / 1824;
    overflow: hidden;
  }

  /* Cover / Album / CoverPhoto: full-height image area (no text overlay sibling) */
  .slide-img-wrap[data-layout="cover"],
  .slide-img-wrap[data-layout="cover_photo"],
  .slide-img-wrap[data-layout="epilogue_album"] {
    flex: 1;
    min-height: 0;
    max-height: none;
  }
  .page-bg-blur {
    display: block;
    position: absolute;
    top: -40px; left: -40px; right: -40px; bottom: -40px;
    background-size: cover;
    background-position: center;
    transform: scale(1.15);
    z-index: 0;
  }
  .slide-img-wrap .page-bg-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: block;
    z-index: 1;
    object-fit: cover;
    object-position: center;
  }

  .carousel-slide .page-text-overlay {
    position: relative;
    top: auto; bottom: auto;
    transform: none;
    flex: 1;
    min-height: 0;
    background: rgba(20, 20, 30, 0.3);
    overflow: hidden;
  }
  .carousel-slide .page-text-overlay::before {
    content: '';
    position: absolute;
    inset: -40px;
    background-image: var(--page-bg-url);
    background-size: cover;
    background-position: center;
    /* blur + brightness + saturate가 사전 생성 이미지에 포함됨 */
    z-index: 0;
    pointer-events: none;
  }
  .page-text-scroll {
    position: relative;
    z-index: 1;
    height: 100%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 14px 20px;
  }
  .page-text-overlay { padding: 16px 20px; }
  .page-story-text {
    font-size: 15px;
    line-height: 2.0;
    text-shadow: 0 1px 4px rgba(0,0,0,0.6);
    color: rgba(255,255,255,0.95);
    position: relative;
    z-index: 1;
  }

  .page-counter-bar { font-size: 12px; padding: 4px 0 0; }

  .cover-top-title { padding: 28px 16px 12px; }
  .cover-top-title-text { font-size: 22px; }
  .cover-title { font-size: 22px; }
  .cover-subtitle { font-size: 12px; }
  .cover-photo-zone { width: 140px; height: 170px; }

  .thumb { width: 56px; height: 44px; border-radius: 6px; }
  .thumb-add { width: 56px; height: 44px; border-radius: 6px; }
  #thumbnail-strip { gap: 6px; }

  .input-group input { font-size: 16px; }

  /* ===== Desktop: 센터링 + 배경색 + 모바일 폭 유지 ===== */
  @media (min-width: 769px) {
    body { align-items: center; background: #e8e8e8; }
    .top-bar, .preview-area, .step-bar, .bottom-panel, .page-counter-bar {
      max-width: 480px;
      width: 100%;
    }
  }

  /* ===== Print Tab (Step 3) ===== */
  .print-checklist {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 16px;
  }
  .print-check-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: #f8f8f8;
    border-radius: 10px;
    font-size: 13px;
    color: #555;
    transition: background 0.2s;
  }
  .print-check-item.passed {
    background: #f0faf0;
    color: #2d8a4e;
  }
  .print-check-icon {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 12px;
    color: transparent;
    transition: all 0.2s;
  }
  .print-check-item.passed .print-check-icon {
    border-color: #2d8a4e;
    background: #2d8a4e;
    color: #fff;
  }
  .print-btn {
    width: 100%;
    padding: 14px 20px;
    border: none;
    border-radius: 12px;
    background: #ccc;
    color: #fff;
    font-size: 15px;
    font-weight: 700;
    font-family: inherit;
    cursor: not-allowed;
    transition: background 0.2s, transform 0.1s;
  }
  .print-btn.ready {
    background: #6c5ce7;
    cursor: pointer;
  }
  .print-btn.ready:active {
    transform: scale(0.98);
  }
  .print-status {
    text-align: center;
    padding: 20px 16px;
  }
  .print-status-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }
  .print-status-title {
    font-size: 16px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 6px;
  }
  .print-status-desc {
    font-size: 13px;
    color: #888;
    line-height: 1.5;
  }
  .print-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid rgba(108,92,231,0.15);
    border-top-color: #6c5ce7;
    border-radius: 50%;
    animation: cover-spin 0.8s linear infinite;
    margin: 0 auto 12px;
  }

  /* ===== Maintenance Overlay ===== */
  .maintenance-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 99999;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    background: rgba(0, 0, 0, 0.45);
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: 20px;
  }
  .maintenance-overlay.active {
    display: flex;
  }
  .maintenance-icon {
    width: 56px;
    height: 56px;
    border: 3px solid rgba(255,255,255,0.8);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: maintenance-pulse 2s ease-in-out infinite;
  }
  .maintenance-icon svg {
    width: 28px;
    height: 28px;
    fill: rgba(255,255,255,0.9);
  }
  .maintenance-text {
    color: #fff;
    font-size: 18px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-align: center;
    line-height: 1.6;
  }
  .maintenance-sub {
    color: rgba(255,255,255,0.6);
    font-size: 13px;
    text-align: center;
  }
  @keyframes maintenance-pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.08); opacity: 0.8; }
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- Maintenance Overlay -->
<div class="maintenance-overlay" id="maintenance-overlay">
  <div class="maintenance-icon">
    <svg viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>
  </div>
  <div class="maintenance-text">서버 안정화 작업 중입니다</div>
  <div class="maintenance-sub">언제 종료될 지 궁금하면 이 앱 제작자에게 직접 물어보세요.</div>
</div>
<script>
  // ?maintenance=true 파라미터로 유지보수 모드 활성화
  if (new URLSearchParams(location.search).get('maintenance') === 'true') {
    document.getElementById('maintenance-overlay').classList.add('active');
  }
</script>

<!-- Top Bar -->
<div class="top-bar">
  <button class="guide-btn" id="guide-btn">부모님을 위한 스토리텔링 가이드</button>
  <div class="top-bar-right">
    <button class="removebg-toggle" id="removebg-toggle" aria-label="remove.bg 토글">
      <span>rb</span>
      <span class="toggle-switch"></span>
    </button>
  </div>
</div>

<!-- Guide Fullscreen Modal -->
<div class="guide-modal" id="guide-modal">
  <div class="guide-modal-header">
    <h2>스토리텔링 가이드</h2>
    <button class="guide-modal-close" id="guide-modal-close">&times;</button>
  </div>
  <div class="guide-modal-body" id="guide-modal-body"></div>
</div>

<!-- Preview Area -->
<div class="preview-area">
  <div class="page-viewer-wrap">
    <div id="page-viewer"></div>
  </div>
</div>

<!-- Page Counter -->
<div class="page-counter-bar" id="page-counter">1 / 18</div>

<!-- Step Bar -->
<div class="step-bar">
  <div class="step-tab active" data-step="0">
    <span class="step-num">01</span> 사진
  </div>
  <div class="step-tab" data-step="1">
    <span class="step-num">02</span> 페이지
  </div>
  <div class="step-tab" data-step="2">
    <span class="step-num">03</span> 스토리
  </div>
  <div class="step-tab" data-step="3">
    <span class="step-num">04</span> 인쇄
  </div>
</div>

<!-- Bottom Panel -->
<div class="bottom-panel">
  <!-- Step 0: 사진 -->
  <div class="step-content step-content-photo active" id="step-content-0">
    <div id="cover-controls"></div>
  </div>

  <!-- Step 1: 페이지 -->
  <div class="step-content step-content-thumbs" id="step-content-1">
    <div id="thumbnail-strip"></div>
  </div>

  <!-- Step 3: 인쇄 -->
  <div class="step-content" id="step-content-3">
    <div id="print-controls"></div>
  </div>
</div>

<!-- Story Settings Bottom Sheet -->
<div class="story-sheet-backdrop" id="story-sheet-backdrop"></div>
<div class="story-sheet" id="story-sheet">
  <div class="story-sheet-header">
    <span class="story-sheet-title">스토리 설정</span>
    <button class="story-sheet-done" id="story-sheet-done">완료</button>
  </div>
  <div class="story-sheet-body">
    <div class="input-group">
      <label>아이 이름</label>
      <input type="text" id="input-firstName" placeholder="도현" />
    </div>
    <div class="input-group">
      <label>부모 호칭</label>
      <input type="text" id="input-parentNames" placeholder="엄마 아빠" />
    </div>
    <div class="version-switch">
      <button class="version-btn active" data-version="A">베이비 (0~4세)</button>
      <button class="version-btn" data-version="B">키즈 (5~8세)</button>
    </div>
  </div>
</div>

<input type="file" id="cover-photo-input" accept="image/*" multiple hidden>

<!-- Person Selection Modal -->
<div class="person-selection-modal" id="person-selection-modal">
  <h3>아이를 선택해주세요</h3>
  <canvas id="person-selection-canvas"></canvas>
  <div class="person-selection-buttons" id="person-selection-buttons"></div>
</div>

<!-- Album frame picker modal -->
<div class="album-picker-backdrop" id="album-picker-backdrop">
  <div class="album-picker-sheet">
    <div class="album-picker-handle"></div>
    <div class="album-picker-title">추가할 앨범 페이지를 선택하세요</div>
    <div class="album-picker-options">
      <button class="album-picker-opt" data-album-template="0">액자 1개</button>
      <button class="album-picker-opt" data-album-template="1">액자 2개</button>
      <button class="album-picker-opt" data-album-template="2">액자 3개</button>
    </div>
  </div>
</div>

<!-- Album drag ghost -->
<div id="album-drag-ghost" class="album-drag-ghost" style="display:none">
  <img style="width:96px;height:96px;object-fit:cover;border-radius:8px">
</div>
<!-- Album file inputs -->
<input type="file" id="album-file-input" accept="image/*,.heic,.heif" multiple hidden>
<input type="file" id="album-single-file-input" accept="image/*,.heic,.heif" hidden>
<input type="file" id="album-page-file-input" accept="image/*,.heic,.heif" multiple hidden>

<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
<script src="js/pipeline-core.js"></script>
<script>document.write('<script src="js/bookPreviewApp.js?t='+Date.now()+'"><\/script>');</script>
</body>
</html>
